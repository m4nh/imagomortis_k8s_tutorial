---
# PVC for shared data between scheduler and image tasks
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: scheduler-shared-pvc
  namespace: imagomortis
  labels:
    app.kubernetes.io/name: scheduler
    app.kubernetes.io/component: storage
    app.kubernetes.io/part-of: imagomortis
spec:
  accessModes:
    - ReadWriteMany  # Required for multiple schedulers and jobs
  resources:
    requests:
      storage: 5Gi
---
# ServiceAccount for scheduler to create/manage Jobs
apiVersion: v1
kind: ServiceAccount
metadata:
  name: scheduler-sa
  namespace: imagomortis
  labels:
    app.kubernetes.io/name: scheduler
    app.kubernetes.io/component: scheduler
    app.kubernetes.io/part-of: imagomortis
---
# Role to allow scheduler to manage Jobs
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: scheduler-role
  namespace: imagomortis
  labels:
    app.kubernetes.io/name: scheduler
    app.kubernetes.io/component: scheduler
    app.kubernetes.io/part-of: imagomortis
rules:
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["create", "get", "list", "watch", "delete"]
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods/log"]
    verbs: ["get", "list", "watch"]
---
# RoleBinding to bind the role to the service account
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: scheduler-rolebinding
  namespace: imagomortis
  labels:
    app.kubernetes.io/name: scheduler
    app.kubernetes.io/component: scheduler
    app.kubernetes.io/part-of: imagomortis
subjects:
  - kind: ServiceAccount
    name: scheduler-sa
    namespace: imagomortis
roleRef:
  kind: Role
  name: scheduler-role
  apiGroup: rbac.authorization.k8s.io
---
# ClusterRole for scheduler to manage Jobs across namespaces (if needed)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: scheduler-clusterrole
rules:
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["create", "get", "list", "watch", "delete"]
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "list", "watch"]
---
# ClusterRoleBinding to bind the cluster role to the service account
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: scheduler-clusterrolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: scheduler-clusterrole
subjects:
  - kind: ServiceAccount
    name: scheduler-sa
    namespace: imagomortis
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: scheduler
  namespace: imagomortis
  labels:
    app.kubernetes.io/name: scheduler
    app.kubernetes.io/component: scheduler
    app.kubernetes.io/part-of: imagomortis
spec:
  # Multiple replicas supported - uses FOR UPDATE SKIP LOCKED for safe concurrency
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: scheduler
      app.kubernetes.io/component: scheduler
  template:
    metadata:
      labels:
        app.kubernetes.io/name: scheduler
        app.kubernetes.io/component: scheduler
        app.kubernetes.io/part-of: imagomortis
    spec:
      serviceAccountName: scheduler-sa
      containers:
        - name: scheduler
          image: imagomortis/scheduler:latest
          imagePullPolicy: IfNotPresent
          env:
            - name: SCHEDULER_POLL_INTERVAL
              value: "5"
            - name: SCHEDULER_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: SCHEDULER_IMAGE_TASK_IMAGE
              value: "imagomortis/imagetask:latest"
            - name: SCHEDULER_SHARED_VOLUME_PATH
              value: "/app/shared"
            - name: SCHEDULER_DB_HOST
              valueFrom:
                configMapKeyRef:
                  name: imagomortis-config
                  key: POSTGRES_HOST
            - name: SCHEDULER_DB_PORT
              valueFrom:
                configMapKeyRef:
                  name: imagomortis-config
                  key: POSTGRES_PORT
            - name: SCHEDULER_DB_NAME
              valueFrom:
                configMapKeyRef:
                  name: imagomortis-config
                  key: POSTGRES_DB
            - name: SCHEDULER_DB_USER
              valueFrom:
                secretKeyRef:
                  name: imagomortis-db-secret
                  key: POSTGRES_USER
            - name: SCHEDULER_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: imagomortis-db-secret
                  key: POSTGRES_PASSWORD
          volumeMounts:
            - name: shared-data
              mountPath: /app/shared
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "512Mi"
              cpu: "500m"
      volumes:
        - name: shared-data
          persistentVolumeClaim:
            claimName: scheduler-shared-pvc
